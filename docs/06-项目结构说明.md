# 项目结构说明

## 完整目录结构

```
IntelliKnowledge-RAG/
├── backend/                          # 后端服务
│   ├── app/
│   │   ├── __init__.py
│   │   ├── main.py                   # FastAPI应用入口
│   │   ├── config.py                 # 配置管理
│   │   │
│   │   ├── api/                      # API路由
│   │   │   ├── __init__.py
│   │   │   ├── v1/
│   │   │   │   ├── __init__.py
│   │   │   │   ├── auth.py          # 认证接口
│   │   │   │   ├── documents.py     # 文档管理
│   │   │   │   ├── collections.py   # 知识库管理
│   │   │   │   ├── chat.py          # 问答接口
│   │   │   │   ├── search.py        # 检索接口
│   │   │   │   ├── graph.py         # 知识图谱接口
│   │   │   │   └── settings.py      # 配置管理
│   │   │   └── dependencies.py      # 依赖注入
│   │   │
│   │   ├── core/                     # 核心功能
│   │   │   ├── __init__.py
│   │   │   ├── security.py          # 安全认证
│   │   │   ├── config.py            # 配置加载
│   │   │   └── logging.py           # 日志配置
│   │   │
│   │   ├── models/                   # 数据模型
│   │   │   ├── __init__.py
│   │   │   ├── database.py          # 数据库连接
│   │   │   ├── user.py              # 用户模型
│   │   │   ├── collection.py        # 知识库模型
│   │   │   ├── document.py          # 文档模型
│   │   │   ├── chunk.py             # 文档块模型
│   │   │   ├── conversation.py      # 对话模型
│   │   │   └── message.py           # 消息模型
│   │   │
│   │   ├── schemas/                  # Pydantic模式
│   │   │   ├── __init__.py
│   │   │   ├── user.py
│   │   │   ├── document.py
│   │   │   ├── chat.py
│   │   │   └── search.py
│   │   │
│   │   ├── services/                 # 业务逻辑
│   │   │   ├── __init__.py
│   │   │   ├── ingestion/           # 文档摄入
│   │   │   │   ├── __init__.py
│   │   │   │   ├── parsers/         # 解析器
│   │   │   │   │   ├── pdf_parser.py
│   │   │   │   │   ├── markdown_parser.py
│   │   │   │   │   ├── docx_parser.py
│   │   │   │   │   └── image_parser.py
│   │   │   │   ├── chunking.py      # 分块策略
│   │   │   │   ├── embedding.py     # 向量化
│   │   │   │   └── pipeline.py      # 完整流程
│   │   │   │
│   │   │   ├── retrieval/           # 检索服务
│   │   │   │   ├── __init__.py
│   │   │   │   ├── vector_retriever.py    # 向量检索
│   │   │   │   ├── keyword_retriever.py   # 关键词检索
│   │   │   │   ├── graph_retriever.py     # 图谱检索
│   │   │   │   ├── hybrid_retriever.py    # 混合检索
│   │   │   │   └── reranker.py            # 重排序
│   │   │   │
│   │   │   ├── agentic/             # Agent工作流
│   │   │   │   ├── __init__.py
│   │   │   │   ├── workflow.py      # LangGraph工作流
│   │   │   │   ├── agents/
│   │   │   │   │   ├── planning.py        # 规划Agent
│   │   │   │   │   ├── retrieval.py       # 检索Agent
│   │   │   │   │   ├── generation.py      # 生成Agent
│   │   │   │   │   ├── reflection.py      # 反思Agent
│   │   │   │   │   └── rewriting.py       # 改写Agent
│   │   │   │   └── state.py         # 状态定义
│   │   │   │
│   │   │   ├── knowledge_graph/     # 知识图谱
│   │   │   │   ├── __init__.py
│   │   │   │   ├── builder.py       # 图谱构建
│   │   │   │   ├── ner.py           # 实体识别
│   │   │   │   ├── relation_extraction.py # 关系抽取
│   │   │   │   └── neo4j_client.py  # Neo4j客户端
│   │   │   │
│   │   │   └── llm/                 # LLM服务
│   │   │       ├── __init__.py
│   │   │       ├── openai_client.py
│   │   │       ├── anthropic_client.py
│   │   │       └── local_client.py
│   │   │
│   │   ├── db/                       # 数据库客户端
│   │   │   ├── __init__.py
│   │   │   ├── postgres.py          # PostgreSQL
│   │   │   ├── milvus.py            # Milvus
│   │   │   ├── neo4j.py             # Neo4j
│   │   │   ├── redis.py             # Redis
│   │   │   └── storage.py           # 对象存储(MinIO/S3)
│   │   │
│   │   ├── utils/                    # 工具函数
│   │   │   ├── __init__.py
│   │   │   ├── file_utils.py
│   │   │   ├── text_utils.py
│   │   │   ├── cache.py
│   │   │   └── monitoring.py
│   │   │
│   │   └── tasks/                    # 异步任务
│   │       ├── __init__.py
│   │       ├── celery_app.py
│   │       ├── document_tasks.py
│   │       └── graph_tasks.py
│   │
│   ├── alembic/                      # 数据库迁移
│   │   ├── versions/
│   │   ├── env.py
│   │   └── alembic.ini
│   │
│   ├── tests/                        # 测试
│   │   ├── __init__.py
│   │   ├── conftest.py              # pytest配置
│   │   ├── unit/                    # 单元测试
│   │   ├── integration/             # 集成测试
│   │   └── e2e/                     # 端到端测试
│   │
│   ├── requirements.txt              # 依赖列表
│   ├── requirements-dev.txt          # 开发依赖
│   ├── Dockerfile
│   └── .env.example
│
├── frontend/                         # 前端应用
│   ├── public/
│   │   ├── index.html
│   │   └── favicon.ico
│   │
│   ├── src/
│   │   ├── main.tsx                 # 入口文件
│   │   ├── App.tsx
│   │   │
│   │   ├── components/              # 组件
│   │   │   ├── layout/
│   │   │   │   ├── Header.tsx
│   │   │   │   ├── Sidebar.tsx
│   │   │   │   └── Layout.tsx
│   │   │   │
│   │   │   ├── document/
│   │   │   │   ├── DocumentUpload.tsx
│   │   │   │   ├── DocumentList.tsx
│   │   │   │   ├── DocumentCard.tsx
│   │   │   │   └── DocumentViewer.tsx
│   │   │   │
│   │   │   ├── chat/
│   │   │   │   ├── ChatInterface.tsx
│   │   │   │   ├── MessageBubble.tsx
│   │   │   │   ├── SourceCard.tsx
│   │   │   │   └── ConversationList.tsx
│   │   │   │
│   │   │   ├── graph/
│   │   │   │   ├── GraphVisualization.tsx
│   │   │   │   └── EntityCard.tsx
│   │   │   │
│   │   │   └── common/
│   │   │       ├── Button.tsx
│   │   │       ├── Input.tsx
│   │   │       └── Loading.tsx
│   │   │
│   │   ├── pages/                   # 页面
│   │   │   ├── Login.tsx
│   │   │   ├── Dashboard.tsx
│   │   │   ├── Collections.tsx
│   │   │   ├── Documents.tsx
│   │   │   ├── Chat.tsx
│   │   │   ├── Graph.tsx
│   │   │   └── Settings.tsx
│   │   │
│   │   ├── hooks/                   # 自定义Hooks
│   │   │   ├── useAuth.ts
│   │   │   ├── useDocuments.ts
│   │   │   ├── useChat.ts
│   │   │   └── useWebSocket.ts
│   │   │
│   │   ├── store/                   # 状态管理(Zustand)
│   │   │   ├── authStore.ts
│   │   │   ├── documentStore.ts
│   │   │   └── chatStore.ts
│   │   │
│   │   ├── api/                     # API客户端
│   │   │   ├── client.ts
│   │   │   ├── auth.ts
│   │   │   ├── documents.ts
│   │   │   ├── chat.ts
│   │   │   └── graph.ts
│   │   │
│   │   ├── utils/                   # 工具函数
│   │   │   ├── format.ts
│   │   │   ├── validation.ts
│   │   │   └── constants.ts
│   │   │
│   │   └── types/                   # TypeScript类型
│   │       ├── user.ts
│   │       ├── document.ts
│   │       └── chat.ts
│   │
│   ├── package.json
│   ├── vite.config.ts
│   ├── tsconfig.json
│   └── Dockerfile
│
├── scripts/                          # 脚本
│   ├── init_db.sh                   # 初始化数据库
│   ├── backup.sh                    # 备份脚本
│   ├── deploy.sh                    # 部署脚本
│   └── seed_data.py                 # 测试数据
│
├── docs/                             # 文档
│   ├── 01-产品需求文档PRD.md
│   ├── 05-开发计划与里程碑.md
│   └── 06-项目结构说明.md
│
├── architecture/                     # 架构文档
│   ├── 02-技术架构设计.md
│   └── 04-数据库设计文档.md
│
├── api-design/                       # API文档
│   └── 03-API接口设计文档.md
│
├── deployment/                       # 部署配置
│   ├── docker-compose.yml           # 开发环境
│   ├── docker-compose.prod.yml      # 生产环境
│   │
│   ├── kubernetes/                  # K8s配置
│   │   ├── backend-deployment.yaml
│   │   ├── frontend-deployment.yaml
│   │   ├── postgres-statefulset.yaml
│   │   ├── milvus-deployment.yaml
│   │   ├── redis-deployment.yaml
│   │   └── ingress.yaml
│   │
│   └── nginx/                       # Nginx配置
│       └── nginx.conf
│
├── monitoring/                       # 监控配置
│   ├── prometheus/
│   │   └── prometheus.yml
│   ├── grafana/
│   │   └── dashboards/
│   └── elk/
│       ├── logstash.conf
│       └── elasticsearch.yml
│
├── .github/                          # GitHub配置
│   ├── workflows/
│   │   ├── ci.yml                   # 持续集成
│   │   ├── cd.yml                   # 持续部署
│   │   └── tests.yml                # 自动化测试
│   └── ISSUE_TEMPLATE/
│
├── .gitignore
├── .env.example                      # 环境变量示例
├── docker-compose.yml                # Docker编排
├── Makefile                          # 快捷命令
├── LICENSE                           # 开源协议
└── README.md                         # 项目说明
```

---

## 核心目录说明

### 后端 (backend/)

#### app/api/
API路由定义，按版本组织（v1/v2），每个模块对应一组相关接口。

**关键文件**：
- `auth.py`: 用户注册、登录、JWT认证
- `documents.py`: 文档上传、列表、删除
- `chat.py`: 问答接口（支持流式响应）
- `search.py`: 检索接口（向量、关键词、混合）
- `graph.py`: 知识图谱查询接口

#### app/services/
核心业务逻辑，分为多个子模块：

**ingestion/**：文档摄入流程
- 多格式解析器（PDF、Markdown、Word等）
- 智能分块（固定长度、语义边界）
- Embedding生成
- 完整Pipeline编排

**retrieval/**：检索服务
- 向量检索（Milvus）
- 关键词检索（BM25/Elasticsearch）
- 图谱检索（Neo4j）
- 混合检索 + RRF融合
- Reranking（Cross-Encoder）

**agentic/**：Agent工作流
- LangGraph状态机
- 多个Agent节点（Planning、Retrieval、Generation、Reflection）
- 条件路由和迭代优化

**knowledge_graph/**：知识图谱
- NER实体识别
- 关系抽取
- Neo4j图谱构建
- 子图查询

#### app/models/
SQLAlchemy ORM模型，定义数据库表结构。

#### app/schemas/
Pydantic数据验证模式，用于API请求/响应。

#### app/db/
各类数据库客户端封装，提供统一接口。

---

### 前端 (frontend/)

#### src/components/
可复用的React组件，按功能模块组织。

**关键模块**：
- `layout/`: 页面布局组件
- `document/`: 文档管理相关组件
- `chat/`: 聊天界面组件
- `graph/`: 知识图谱可视化

#### src/pages/
页面级组件，对应路由。

#### src/store/
Zustand状态管理，按业务模块划分。

#### src/api/
API客户端封装，使用Axios或Fetch。

---

### 部署 (deployment/)

#### docker-compose.yml
开发环境一键启动配置，包含所有依赖服务。

#### kubernetes/
生产环境K8s配置，支持自动扩缩容、滚动更新。

---

### 监控 (monitoring/)

#### prometheus/
指标收集配置，定义抓取目标和规则。

#### grafana/
仪表盘配置，可视化系统性能。

#### elk/
日志收集和分析配置。

---

## 关键文件说明

### backend/app/main.py
FastAPI应用入口，注册路由、中间件、异常处理。

```python
from fastapi import FastAPI
from app.api.v1 import auth, documents, chat

app = FastAPI(title="IntelliKnowledge API")

# 注册路由
app.include_router(auth.router, prefix="/api/v1/auth")
app.include_router(documents.router, prefix="/api/v1/documents")
app.include_router(chat.router, prefix="/api/v1/chat")

# 中间件
app.add_middleware(CORSMiddleware, ...)
app.add_middleware(RateLimitMiddleware, ...)

# 健康检查
@app.get("/health")
def health():
    return {"status": "ok"}
```

### backend/app/services/agentic/workflow.py
LangGraph Agent工作流定义。

```python
from langgraph.graph import StateGraph

workflow = StateGraph(AgentState)
workflow.add_node("planning", planning_node)
workflow.add_node("retrieval", retrieval_node)
workflow.add_node("generation", generation_node)
workflow.add_node("reflection", reflection_node)

# 定义边
workflow.add_edge("planning", "retrieval")
workflow.add_conditional_edges("reflection", should_continue)

agent = workflow.compile()
```

### frontend/src/main.tsx
React应用入口。

```tsx
import React from 'react'
import ReactDOM from 'react-dom/client'
import { BrowserRouter } from 'react-router-dom'
import App from './App'

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </React.StrictMode>,
)
```

### docker-compose.yml
服务编排配置。

```yaml
version: '3.8'
services:
  backend:
    build: ./backend
    ports: ["8000:8000"]
    depends_on: [postgres, milvus, redis]

  frontend:
    build: ./frontend
    ports: ["3000:3000"]

  postgres:
    image: postgres:15
    volumes: [postgres_data:/var/lib/postgresql/data]

  milvus:
    image: milvusdb/milvus:v2.3.0
    ...
```

---

## 配置文件

### .env.example
环境变量模板，包含所有必需配置。

```bash
# 数据库
DATABASE_URL=postgresql://user:pass@localhost:5432/intelliknowledge

# Redis
REDIS_URL=redis://localhost:6379

# Milvus
MILVUS_HOST=localhost
MILVUS_PORT=19530

# LLM API
OPENAI_API_KEY=sk-...
OPENAI_BASE_URL=https://api.openai.com/v1

# Neo4j
NEO4J_URI=bolt://localhost:7687
NEO4J_USER=neo4j
NEO4J_PASSWORD=password

# 对象存储
MINIO_ENDPOINT=localhost:9000
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin
```

---

## 开发工作流

### 1. 启动开发环境

```bash
# 启动所有依赖服务
docker-compose up -d postgres redis milvus

# 启动后端（开发模式）
cd backend
uvicorn app.main:app --reload

# 启动前端（开发模式）
cd frontend
npm run dev
```

### 2. 数据库迁移

```bash
# 创建迁移
alembic revision --autogenerate -m "Add new table"

# 执行迁移
alembic upgrade head

# 回滚
alembic downgrade -1
```

### 3. 运行测试

```bash
# 后端测试
pytest tests/ -v --cov

# 前端测试
npm run test
```

### 4. 代码格式化

```bash
# Python
black backend/
flake8 backend/

# TypeScript
npm run lint
npm run format
```

---

## 部署流程

### 开发环境
```bash
docker-compose up -d
```

### 生产环境
```bash
# 构建镜像
docker build -t intelliknowledge/backend:latest ./backend
docker build -t intelliknowledge/frontend:latest ./frontend

# 推送到镜像仓库
docker push intelliknowledge/backend:latest

# K8s部署
kubectl apply -f deployment/kubernetes/
```

---

**文档版本**：v1.0
**最后更新**：2025-12-04
